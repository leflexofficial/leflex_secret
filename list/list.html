<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title id="pageTitle">채널 대시보드</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    .dashboard-header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;  /* 왼쪽 정렬 */
      gap: 6px;
      margin-bottom: 20px;
    }

    .header-left {
      display: flex;
      flex-direction: column;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      text-align: left;
    }

    label {
      margin-top: 8px;
      font-size: 14px;
    }

    select {
      padding: 5px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: #fff;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg%20fill='%23666'%20height='24'%20viewBox='0%200%2024%2024'%20width='24'%20xmlns='http://www.w3.org/2000/svg'%3E%3Cpath%20d='M7%2010l5%205%205-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px 16px;
      min-width: 120px;
    }

    .dashboard-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      overflow-x: auto;
      white-space: nowrap;
    }

    table {
      border-collapse: collapse;
      font-size: 14px;
      min-width: 400px;
    }

    th, td {
      border: 1px solid #aaa;
      padding: 6px 10px;
      text-align: center;
      height: 20px;
      line-height: 20px;
      box-sizing: border-box;
    }

    th {
      background: #f0f0f0;
    }

    th.vat {
      background: #fff4e0;
      color: #d14300;
      font-weight: bold;
    }

    td.numeric {
      text-align: right;
    }

    .detail-tables {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .detail-table {
      min-width: 300px;
      flex: 0 0 auto;
    }

    .product-title {
      font-weight: bold;
      margin: 4px 0 5px;
    }

    tr.total-row {
      background-color: #fff4e0;
      font-weight: bold;
      color: #d14300;
    }
  </style>
</head>
<body>
  <div class="dashboard-header">
    <div class="header-left">
      <h1 id="mainTitle">대시보드</h1>
      <label for="monthSelect">월 선택: 
        <select id="monthSelect"></select>
      </label>
    </div>
  </div>

  <div class="dashboard-container">
    <div class="summary-table">
      <table id="summaryTable">
        <thead>
          <tr>
            <th colspan="4" style="background:#f8f8f8;">LEFLEX 할인판매 현황</th>
            <th class="vat">VAT포함</th>
          </tr>
          <tr>
            <th>날짜</th>
            <th>주문수</th>
            <th>환불수</th>
            <th>판매수</th>
            <th>판매합계</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="detail-tables" id="detailTables"></div>
  </div>

  <script src="../js/data.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const youtuber = params.get("name") || "Unknown";

    document.getElementById("pageTitle").textContent = `채널명: ${youtuber}`;
    document.getElementById("mainTitle").textContent = `채널명: ${youtuber}`;

    const monthSelect = document.getElementById("monthSelect");
    const summaryBody = document.querySelector("#summaryTable tbody");
    const detailTablesContainer = document.getElementById("detailTables");

    const months = [...new Set(salesData
      .filter(r => r.youtuber === youtuber)
      .map(r => r.month))].sort();

    months.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      monthSelect.appendChild(opt);
    });

    monthSelect.addEventListener("change", renderDashboard);

    function renderDashboard() {
      const selectedMonth = monthSelect.value;
      const filtered = salesData.filter(r => r.youtuber === youtuber && r.month === selectedMonth);

      renderSummaryTable(filtered);
      renderDetailTables(filtered);
    }

    function renderSummaryTable(rows) {
      summaryBody.innerHTML = "";

      const grouped = rows.reduce((acc, row) => {
        if (!acc[row.date]) {
          acc[row.date] = { date: row.date, order: 0, refund: 0, qty: 0, amount: 0 };
        }
        acc[row.date].order += row.order_count;
        acc[row.date].refund += row.refund_count;
        acc[row.date].qty += row.sale_qty;
        acc[row.date].amount += row.sale_amount;
        return acc;
      }, {});

      let totalOrder = 0, totalRefund = 0, totalQty = 0, totalAmount = 0;

      Object.values(grouped).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td class="numeric">${r.order.toLocaleString()}</td>
          <td class="numeric">${r.refund.toLocaleString()}</td>
          <td class="numeric">${r.qty.toLocaleString()}</td>
          <td class="numeric">${r.amount.toLocaleString()}</td>
        `;
        summaryBody.appendChild(tr);
        totalOrder += r.order;
        totalRefund += r.refund;
        totalQty += r.qty;
        totalAmount += r.amount;
      });

      let tfoot = document.querySelector("#summaryTable tfoot");
      if (tfoot) tfoot.remove();
      tfoot = document.createElement("tfoot");

      const totalRow = document.createElement("tr");
      totalRow.classList.add("total-row");
      totalRow.innerHTML = `
        <td>합계</td>
        <td class="numeric">${totalOrder.toLocaleString()}</td>
        <td class="numeric">${totalRefund.toLocaleString()}</td>
        <td class="numeric">${totalQty.toLocaleString()}</td>
        <td class="numeric">${totalAmount.toLocaleString()}</td>
      `;
      tfoot.appendChild(totalRow);

      document.getElementById("summaryTable").appendChild(tfoot);
    }

    function renderDetailTables(rows) {
      detailTablesContainer.innerHTML = "";

      const productPriority = ["마스크", "손등장갑(오른손)", "손등장갑(양손)"];
      const products = productPriority.filter(p =>
        rows.some(r => r.product === p)
      );

      products.forEach(product => {
        const productRows = rows.filter(r => r.product === product);

        const div = document.createElement("div");
        div.className = "detail-table";

        const title = document.createElement("div");
        title.className = "product-title";

        let price = "13,200원";
        if (product === "손등장갑(오른손)") price = "11,000원";
        else if (product === "손등장갑(양손)") price = "19,800원";

        const prefix = product === "마스크" ? "[판매 세부] " : "";
        title.innerText = `${prefix}${product} / 판매가: ${price} (VAT 포함)`;
        div.appendChild(title);

        const table = document.createElement("table");
        const tbody = document.createElement("tbody");
        tbody.innerHTML = productRows.map(r => ` 
          <tr>
            <td class="numeric">${r.order_count.toLocaleString()}</td>
            <td class="numeric">${r.refund_count.toLocaleString()}</td>
            <td class="numeric">${r.sale_qty.toLocaleString()}</td>
            <td class="numeric">${r.sale_amount.toLocaleString()}</td>
          </tr>
        `).join("");

        const totalOrder = productRows.reduce((sum, r) => sum + r.order_count, 0);
        const totalRefund = productRows.reduce((sum, r) => sum + r.refund_count, 0);
        const totalQty = productRows.reduce((sum, r) => sum + r.sale_qty, 0);
        const totalAmount = productRows.reduce((sum, r) => sum + r.sale_amount, 0);

        const tfoot = document.createElement("tfoot");
        tfoot.innerHTML = `
          <tr class="total-row">
            <td class="numeric">${totalOrder.toLocaleString()}</td>
            <td class="numeric">${totalRefund.toLocaleString()}</td>
            <td class="numeric">${totalQty.toLocaleString()}</td>
            <td class="numeric">${totalAmount.toLocaleString()}</td>
          </tr>
        `;

        table.innerHTML = `
          <thead>
            <tr>
              <th>주문수</th>
              <th>환불수</th>
              <th>판매수</th>
              <th>판매합계</th>
            </tr>
          </thead>
        `;
        table.appendChild(tbody);
        table.appendChild(tfoot);
        div.appendChild(table);
        detailTablesContainer.appendChild(div);
      });
    }

    if (months.length > 0) {
      monthSelect.value = months[0];
      renderDashboard();
    }
  </script>
</body>
</html>
